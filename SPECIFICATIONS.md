
# 機能仕様書: Dynamic Sheets Reporter v2.0

本ドキュメントは、v2.0で実装される各機能の具体的な仕様を定義します。

## 1. ユーザー設定
* **目的:** 各ユーザーが自身のGemini APIキーと使用モデルを設定できるようにする。
* **UI:**
    * ヘッダーに設定アイコン（歯車）を配置。
    * クリックするとモーダルダイアログが表示される。
    * ダイアログには「Gemini APIキー」のパスワード入力フィールドと、「使用モデル」のドロップダウンリスト（例: `gemini-1.5-pro-latest`, `gemini-1.5-flash-latest`）が表示される。
    * 「保存」ボタンと「キャンセル」ボタンを配置。
* **処理フロー:**
    1.  ユーザーが情報を入力し「保存」をクリック。
    2.  フロントエンドは `UserSettingsController.save(settings)` を呼び出す。
    3.  GASバックエンドは `PropertiesService.getUserProperties()` を使用して、キー (`GEMINI_API_KEY`, `GEMINI_MODEL`) と値を保存する。
    4.  ツール起動時、フロントエンドは `UserSettingsController.get()` を呼び出し、設定が完了しているか確認する。未設定の場合、設定を促すメッセージを表示する。

## 2. 自然言語クエリ
* **目的:** ユーザーが自然言語で分析を指示できるようにする。
* **UI:** メイン画面に大きなテキスト入力エリアを配置。
* **処理フロー:**
    1.  ユーザーが「先月の製品Aの担当者別平均解決時間」と入力し、実行ボタンを押す。
    2.  フロントエンドは `QueryController.executeQueryFromNaturalLanguage(spreadsheetId, sheetName, queryText)` を呼び出す。
    3.  GAS `QueryService`は、対象シートのスキーマ情報（ヘッダー名、推測されるデータ型）をキャッシュまたは動的に取得する。
    4.  `QueryService`は、Gemini APIに対して以下の要素を含むプロンプトを送信する：
        * **役割:** 「あなたはデータアナリストで、自然言語を構造化クエリJSONに変換する専門家です。」
        * **コンテキスト:** 「以下のスキーマを持つデータがあります: `{ "columns": [{"name": "日付", "type": "date"}, {"name": "製品", "type": "string"}, ...] }`」
        * **タスク:** 「ユーザーの次のリクエストを、以下のJSON形式に変換してください: `{"dimensions": ["担当者"], "metrics": [{"field": "解決時間", "aggregation": "average"}], "filters": [{"field": "日付", "operator": "last_month"}, {"field": "製品", "operator": "equals", "value": "A"}]}`」
        * **ユーザーリクエスト:** 「先月の製品Aの担当者別平均解決時間」
    5.  Geminiから返されたJSONをパースし、GAS内部でフィルタリングと集計処理を実行する。
    6.  結果をフロントエンドに返し、テーブルとして表示する。

## 3. プロアクティブ・インサイト
* **目的:** 分析結果からAIが次のアクションに繋がる「気づき」をユーザーに提示する。
* **UI:** データテーブルやチャートの下に、カード形式で3つほどのインサイトを表示するエリアを設ける。
* **処理フロー:**
    1.  データ分析が完了し、結果が表示される。
    2.  フロントエンド（またはバックエンド）は、結果データ（JSON形式）を `InsightController.getInsights(resultData)` に渡す。
    3.  GAS `InsightService`は、Gemini APIに対して以下の要素を含むプロンプトを送信する：
        * **役割:** 「あなたは優秀なデータコンサルタントです。」
        * **コンテキスト:** 「以下の分析結果データがあります: `[{"担当者": "A", "平均解決時間": 120}, ...]`」
        * **タスク:** 「このデータから読み取れる興味深い傾向、外れ値、または特筆すべき相関関係を3つ、簡潔に指摘してください。それぞれの指摘について、さらに深掘りするための構造化クエリJSONも提案してください。」
    4.  結果をパースし、インサイトのテキストと、クリック可能な「深掘りする」ボタンをフロントエンドに表示する。ボタンには次の分析のためのJSONクエリが紐付けられている。

... (AI Join, ビュー保存, Looker連携など、他の機能仕様も同様に詳細化) ...

---